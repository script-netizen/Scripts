-- Load external dependencies
local DrRayLibrary = loadstring(game:HttpGet("https://raw.githubusercontent.com/AZYsGithub/DrRay-UI-Library/main/DrRay.lua"))()

-- Services
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Constants (default values)
local ENERGY_MAX = 101
local CHARGE_MAX = 100
local HITBOX_SIZE = Vector3.new(10, 10, 10)

-- Initialize UI
local window = DrRayLibrary:Load("DrRay!", "Default")
local mainTab = DrRayLibrary.newTab("Main", "ImageIdHere")
local settingsTab = DrRayLibrary.newTab("Settings", "ImageIdHere")

-- State management
local State = {
    player = Players.LocalPlayer,
    character = nil,
    connections = {
        energy = nil,
        charge = nil,
        autoBlock = nil,
        characterAdded = nil,
        noCooldown = nil
    },
    toggleStates = {
        energy = false,
        charge = false,
        autoBlock = false,
        noCooldown = false
    }
}

-- Helper functions
local function stopConnection(connectionName)
    if State.connections[connectionName] then
        State.connections[connectionName]:Disconnect()
        State.connections[connectionName] = nil
    end
end

local function stopAllConnections()
    for name, _ in pairs(State.connections) do
        stopConnection(name)
    end
end

-- No Cooldown hook function
local function setupNoCooldown()
    if State.toggleStates.noCooldown then
        spawn(function()
            local oldWait
            oldWait = hookfunction(wait, function(duration)
                if duration and duration ~= 0 and 
                   tostring(getcallingscript(oldWait)) ~= "nil" and 
                   tonumber(duration) < 2.5 and 
                   State.toggleStates.noCooldown then
                    return oldWait()
                end
                return oldWait(duration)
            end)
        end)
    end
end

local function setupCharacterConnections()
    if not State.character then return end
    
    -- Reconnect active toggles
    for toggle, isActive in pairs(State.toggleStates) do
        if isActive then
            if toggle == "energy" then
                State.connections.energy = RunService.Heartbeat:Connect(function()
                    if State.character:FindFirstChild("Energy") then
                        State.character.Energy.Value = ENERGY_MAX
                    end
                end)
            elseif toggle == "charge" then
                State.connections.charge = RunService.Heartbeat:Connect(function()
                    if State.character:FindFirstChild("Charge") then
                        State.character.Charge.Value = CHARGE_MAX
                    end
                end)
            elseif toggle == "autoBlock" then
                State.connections.autoBlock = RunService.Heartbeat:Connect(function()
                    spawn(function()
                        if State.character then
                            wait()
                            ReplicatedStorage.RemoteEvents.ReplicateGuardOn:FireServer()
                            State.character.Guarding.Value = false
                            wait()
                            ReplicatedStorage.RemoteEvents.ReplicateGuardOff:FireServer()
                        end
                    end)
                end)
            elseif toggle == "noCooldown" then
                setupNoCooldown()
            end
        end
    end
end

local function handleCharacterAdded(char)
    State.character = char
    setupCharacterConnections()
end

-- Initialize character tracking
State.connections.characterAdded = State.player.CharacterAdded:Connect(handleCharacterAdded)
State.character = State.player.Character or State.player.CharacterAdded:Wait()

-- Main Tab UI Elements
mainTab.newButton("Update", "Reconnect player values", function()
    stopAllConnections()
    handleCharacterAdded(State.player.Character)
end)

mainTab.newToggle("FEnergy", "Full Energy!", false, function(state)
    State.toggleStates.energy = state
    stopConnection("energy")
    
    if state then
        State.connections.energy = RunService.Heartbeat:Connect(function()
            if State.character and State.character:FindFirstChild("Energy") then
                State.character.Energy.Value = ENERGY_MAX
            end
        end)
    end
end)

mainTab.newToggle("Full Charge", "Full Charge!", false, function(state)
    State.toggleStates.charge = state
    stopConnection("charge")
    
    if state then
        State.connections.charge = RunService.Heartbeat:Connect(function()
            if State.character and State.character:FindFirstChild("Charge") then
                State.character.Charge.Value = CHARGE_MAX
            end
        end)
    end
end)

mainTab.newToggle("Auto Block", "Blocks most incoming hits (Do not block while active)", false, function(state)
    State.toggleStates.autoBlock = state
    stopConnection("autoBlock")
    
    if state then
        State.connections.autoBlock = RunService.Heartbeat:Connect(function()
            spawn(function()
                if State.character then
                    wait()
                    ReplicatedStorage.RemoteEvents.ReplicateGuardOn:FireServer()
                    State.character.Guarding.Value = false
                    wait()
                    ReplicatedStorage.RemoteEvents.ReplicateGuardOff:FireServer()
                end
            end)
        end)
    end
end)

mainTab.newToggle("No Cooldown", "Removes some cooldowns (may not always work)", false, function(state)
    State.toggleStates.noCooldown = state
    if state then
        setupNoCooldown()
    end
end)

-- Settings Tab UI Elements
settingsTab.newInput("Energy Max", "Set the maximum energy value", function(text)
    local newValue = tonumber(text)
    if newValue then
        ENERGY_MAX = newValue
        print("Energy Max set to:", ENERGY_MAX)
    else
        print("Invalid input. Please enter a number.")
    end
end)

settingsTab.newInput("Charge Max", "Set the maximum charge value", function(text)
    local newValue = tonumber(text)
    if newValue then
        CHARGE_MAX = newValue
        print("Charge Max set to:", CHARGE_MAX)
    else
        print("Invalid input. Please enter a number.")
    end
end)

settingsTab.newInput("Hitbox Size", "Set the hitbox size (format: x,y,z)", function(text)
    local values = {}
    for value in string.gmatch(text, "%d+") do
        table.insert(values, tonumber(value))
    end
    if #values == 3 then
        HITBOX_SIZE = Vector3.new(values[1], values[2], values[3])
        print("Hitbox Size set to:", HITBOX_SIZE)
    else
        print("Invalid input. Please enter values in the format: x,y,z")
    end
end)
