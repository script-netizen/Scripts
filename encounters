-- Load external dependencies
local DrRayLibrary = loadstring(game:HttpGet("https://raw.githubusercontent.com/AZYsGithub/DrRay-UI-Library/main/DrRay.lua"))()

-- Services
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- Constants
local ENERGY_MAX = 101
local CHARGE_MAX = 100
local DEFAULT_GRAVITY = 196.2
local DEFAULT_HITBOX_SIZE = Vector3.new(2, 2, 1)
local MAX_HITBOX_SIZE = Vector3.new(10, 10, 10)

-- Initialize UI
local window = DrRayLibrary:Load("DrRay!", "Default")
local mainTab = DrRayLibrary.newTab("Main", "ImageIdHere")
local generalTab = DrRayLibrary.newTab("General", "ImageIdHere")

-- State management
local State = {
    player = Players.LocalPlayer,
    character = nil,
    connections = {
        energy = nil,
        charge = nil,
        autoBlock = nil,
        characterAdded = nil,
        noCooldown = nil,
        hitboxUpdate = nil
    },
    toggleStates = {
        energy = false,
        charge = false,
        autoBlock = false,
        noCooldown = false,
        hitboxExpander = false
    },
    originalHitboxes = {}
}

-- Helper functions
local function stopConnection(connectionName)
    if State.connections[connectionName] then
        State.connections[connectionName]:Disconnect()
        State.connections[connectionName] = nil
    end
end

local function stopAllConnections()
    for name, _ in pairs(State.connections) do
        stopConnection(name)
    end
end

-- Store original hitbox sizes
local function storeOriginalHitbox(part)
    if not State.originalHitboxes[part] then
        State.originalHitboxes[part] = part.Size
    end
end

-- Reset hitboxes to original size
local function resetHitboxes()
    if State.character then
        for _, part in pairs(State.character:GetChildren()) do
            if part:IsA("BasePart") and State.originalHitboxes[part] then
                part.Size = State.originalHitboxes[part]
            end
        end
    end
end

-- No Cooldown hook function
local function setupNoCooldown()
    if State.toggleStates.noCooldown then
        spawn(function()
            local oldWait
            oldWait = hookfunction(wait, function(duration)
                if duration and duration ~= 0 and 
                   tostring(getcallingscript(oldWait)) ~= "nil" and 
                   tonumber(duration) < 2.5 and 
                   State.toggleStates.noCooldown then
                    return oldWait()
                end
                return oldWait(duration)
            end)
        end)
    end
end

local function setupCharacterConnections()
    if not State.character then return end
    
    -- Reconnect active toggles
    for toggle, isActive in pairs(State.toggleStates) do
        if isActive then
            if toggle == "energy" then
                State.connections.energy = RunService.Heartbeat:Connect(function()
                    if State.character:FindFirstChild("Energy") then
                        State.character.Energy.Value = ENERGY_MAX
                    end
                end)
            elseif toggle == "charge" then
                State.connections.charge = RunService.Heartbeat:Connect(function()
                    if State.character:FindFirstChild("Charge") then
                        State.character.Charge.Value = CHARGE_MAX
                    end
                end)
            elseif toggle == "autoBlock" then
                State.connections.autoBlock = RunService.Heartbeat:Connect(function()
                    spawn(function()
                        if State.character then
                            wait()
                            ReplicatedStorage.RemoteEvents.ReplicateGuardOn:FireServer()
                            State.character.Guarding.Value = false
                            wait()
                            ReplicatedStorage.RemoteEvents.ReplicateGuardOff:FireServer()
                        end
                    end)
                end)
            elseif toggle == "noCooldown" then
                setupNoCooldown()
            elseif toggle == "hitboxExpander" then
                -- Store original sizes when first enabled
                for _, part in pairs(State.character:GetChildren()) do
                    if part:IsA("BasePart") then
                        storeOriginalHitbox(part)
                    end
                end
            end
        end
    end
end

local function handleCharacterAdded(char)
    State.character = char
    State.originalHitboxes = {} -- Reset stored hitboxes
    setupCharacterConnections()
end

-- Initialize character tracking
State.connections.characterAdded = State.player.CharacterAdded:Connect(handleCharacterAdded)
State.character = State.player.Character or State.player.CharacterAdded:Wait()

-- Main Tab UI Elements
mainTab.newButton("Update", "Reconnect player values", function()
    stopAllConnections()
    handleCharacterAdded(State.player.Character)
end)

mainTab.newButton("Reset Spin Wheel", "Resets the wheel spin cooldown", function()
    if State.character and State.character:FindFirstChild("LastWheelSpin") then
        State.character.LastWheelSpin.Value = 0
    end
end)

mainTab.newToggle("FEnergy", "Full Energy!", false, function(state)
    State.toggleStates.energy = state
    stopConnection("energy")
    
    if state then
        State.connections.energy = RunService.Heartbeat:Connect(function()
            if State.character and State.character:FindFirstChild("Energy") then
                State.character.Energy.Value = ENERGY_MAX
            end
        end)
    end
end)

mainTab.newToggle("Full Charge", "Full Charge!", false, function(state)
    State.toggleStates.charge = state
    stopConnection("charge")
    
    if state then
        State.connections.charge = RunService.Heartbeat:Connect(function()
            if State.character and State.character:FindFirstChild("Charge") then
                State.character.Charge.Value = CHARGE_MAX
            end
        end)
    end
end)

mainTab.newToggle("Auto Block", "Blocks most incoming hits (Do not block while active)", false, function(state)
    State.toggleStates.autoBlock = state
    stopConnection("autoBlock")
    
    if state then
        State.connections.autoBlock = RunService.Heartbeat:Connect(function()
            spawn(function()
                if State.character then
                    wait()
                    ReplicatedStorage.RemoteEvents.ReplicateGuardOn:FireServer()
                    State.character.Guarding.Value = false
                    wait()
                    ReplicatedStorage.RemoteEvents.ReplicateGuardOff:FireServer()
                end
            end)
        end)
    end
end)

mainTab.newToggle("No Cooldown", "Removes some cooldowns (may not always work)", false, function(state)
    State.toggleStates.noCooldown = state
    if state then
        setupNoCooldown()
    end
end)

-- General Tab UI Elements
generalTab.newSlider("Gravity", "Adjust workspace gravity", 0, 196.2, 196.2, function(value)
    Workspace.Gravity = value
end)

generalTab.newButton("Reset Gravity", "Reset to default gravity", function()
    Workspace.Gravity = DEFAULT_GRAVITY
end)

generalTab.newToggle("Hitbox Expander", "Increases character hitbox size", false, function(state)
    State.toggleStates.hitboxExpander = state
    
    if state then
        -- Store original sizes and expand hitboxes
        for _, part in pairs(State.character:GetChildren()) do
            if part:IsA("BasePart") then
                storeOriginalHitbox(part)
                part.Size = MAX_HITBOX_SIZE
            end
        end
    else
        -- Reset hitboxes to original size
        resetHitboxes()
    end
end)
